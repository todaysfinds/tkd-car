{% extends "base.html" %}

{% block page_title %}ì˜¤ëŠ˜ ìš´í–‰ í˜„í™©{% endblock %}

{% block content %}
<div class="px-4 py-6">
    <!-- ëŒ€ê¸° ì¤‘ì¸ ìš”ì²­ ì•Œë¦¼ -->
    {% set pending_requests = [] %}
    {% for time_key, locations in time_groups.items() %}
        {% for location, students in locations.items() %}
            {% for student_data in students %}
                {% if student_data.request and student_data.request.status == 'pending' %}
                    {% set _ = pending_requests.append(student_data.request) %}
                {% endif %}
            {% endfor %}
        {% endfor %}
    {% endfor %}

    {% if pending_requests %}
        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-6">
            <h3 class="text-sm font-semibold text-orange-800 mb-3">ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ìš”ì²­ ({{ pending_requests|length }}ê±´)</h3>
            {% for request in pending_requests %}
            <div class="bg-orange-100 border border-orange-300 rounded-lg p-3">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <span class="text-sm font-medium text-orange-800">{{ request.student.name }}</span>
                        <span class="text-xs text-orange-600 ml-2">
                            {% if request.request_type == 'absence' %}ê²°ì„ ìš”ì²­{% endif %}
                            {% if request.request_type == 'pickup_skip' %}ì§ì ‘ë“±ì› ìš”ì²­{% endif %}
                            {% if request.request_type == 'dropoff_skip' %}ë„ì¥í”½ì—… ìš”ì²­{% endif %}
                        </span>
                    </div>
                    <button onclick="approveRequest({{ request.id }})"
                            class="bg-orange-600 hover:bg-orange-700 text-white text-xs px-3 py-1 rounded">
                        ìŠ¹ì¸
                    </button>
                </div>
            </div>
            {% endfor %}
            
            {% if pending_requests|length > 1 %}
            <button onclick="approveAllRequests()" 
                    class="w-full bg-orange-600 hover:bg-orange-700 text-white text-sm py-2 rounded-lg">
                ëª¨ë“  ìš”ì²­ ì¼ê´„ ìŠ¹ì¸
            </button>
            {% endif %}
        </div>
    {% endif %}

    {% if time_groups %}
        <!-- ì‹œê°„ëŒ€ ë„¤ë¹„ê²Œì´ì…˜ (í™•ì‹¤í•œ ë¶„ë¦¬ êµ¬ì¡°) -->
        <div class="flex items-center justify-center mb-6 px-4">
            <!-- ì™¼ìª½ í™”ì‚´í‘œ -->
                <button onclick="previousSlide()" 
                    class="flex-shrink-0 w-12 h-12 bg-white hover:bg-blue-50 flex items-center justify-center text-2xl border-2 border-blue-300 rounded-full shadow-lg mr-8 transition-all hover:scale-110 z-30">
                    â¬…ï¸
                </button>
                
            <!-- ì‹œê°„ ë²„íŠ¼ë“¤ ì»¨í…Œì´ë„ˆ (ì¶©ë¶„í•œ ì—¬ë°±) -->
            <div class="flex-1 max-w-2xl">
                <div class="overflow-x-auto scrollbar-hide" id="timeNavContainer">
                    <div class="flex space-x-4 justify-center min-w-max py-2 px-8">
                        {% for time_key in time_groups.keys() %}
                        <button onclick="scrollToTimeSlot('{{ time_key }}')" id="nav-{{ time_key }}"
                                class="flex-shrink-0 px-6 py-3 text-base font-bold bg-white border-2 border-gray-300 rounded-2xl hover:bg-blue-50 hover:border-blue-400 transition-all duration-200 shadow-lg whitespace-nowrap min-w-[80px]">
                            {{ time_key.replace(' PM', '') }}
                        </button>
                        {% endfor %}
                    </div>
                    </div>
                </div>
                
            <!-- ì˜¤ë¥¸ìª½ í™”ì‚´í‘œ -->
                <button onclick="nextSlide()" 
                    class="flex-shrink-0 w-12 h-12 bg-white hover:bg-blue-50 flex items-center justify-center text-2xl border-2 border-blue-300 rounded-full shadow-lg ml-8 transition-all hover:scale-110 z-30">
                    â¡ï¸
                </button>
        </div>

        <!-- ì‹œê°„ëŒ€ë³„ ìŠ¬ë¼ì´ë“œ -->
        <div class="space-y-6" id="timeSlides">
            {% for time_key, locations in time_groups.items() %}
            <div class="slide-item" id="slot-{{ time_key }}" style="display: none;">
                <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-6">
                    <!-- ì‹œê°„ëŒ€ í—¤ë” -->
                    <div class="mb-6 text-center">
                        <div class="flex items-center justify-center mb-2">
                            <h2 class="text-2xl font-bold text-gray-900">{{ time_key }}</h2>
                            <button onclick="toggleTimeSlotMemo('{{ time_key }}')" 
                                    class="ml-3 p-1 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded transition-colors"
                                    title="ì‹œê°„ëŒ€ ë©”ëª¨">
                                ğŸ“
                            </button>
                        </div>
                        <div class="w-16 h-1 bg-blue-500 rounded-full mx-auto"></div>
                        
                        <!-- ë¹ ë¥¸ ì „í™”ê±¸ê¸° ë²„íŠ¼ë“¤ (ì •ì„ êµ¬í˜„) -->
                        <div class="flex gap-2 justify-center mt-3" id="quickCallButtons-{{ time_key }}">
                            <!-- JavaScriptë¡œ ë™ì  ë¡œë“œ -->
                        </div>
                        
                        <!-- ì‹œê°„ëŒ€ë³„ ë©”ëª¨ -->
                        <div id="memo-{{ time_key }}" class="mt-4 hidden">
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 max-w-md mx-auto">
                                <textarea 
                                    id="memo-input-{{ time_key }}"
                                    placeholder="ì„ì‹œ í•™ìƒì´ë‚˜ íŠ¹ì´ì‚¬í•­ì„ ë©”ëª¨í•˜ì„¸ìš”..."
                                    class="w-full bg-white border border-yellow-300 rounded px-3 py-2 text-sm resize-none focus:ring-yellow-500 focus:border-yellow-500"
                                    rows="3"
                                    onchange="saveTimeSlotMemo('{{ time_key }}', this.value)"></textarea>
                                <div class="flex justify-between items-center mt-2">
                                    <span class="text-xs text-yellow-600">ğŸ’¡ ì¼íšŒì„± ë©”ëª¨ (ë‚´ì¼ ì´ˆê¸°í™”ë¨)</span>
                                    <button onclick="clearTimeSlotMemo('{{ time_key }}')" 
                                            class="text-xs text-red-500 hover:text-red-700">ì§€ìš°ê¸°</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ì¥ì†Œë³„ë¡œ ê·¸ë£¹í™”ëœ í•™ìƒ ëª©ë¡ -->
                    {% for location, students in locations.items() %}
                    <div class="mb-8 last:mb-0">
                        <div class="flex items-center justify-between mb-4">
                            <span class="text-sm font-semibold text-gray-700 bg-gray-100 px-3 py-1 rounded-lg">
                                {{ location }}
                                {% if students[0].student.estimated_pickup_time %}
                                    <span class="ml-2 text-xs text-gray-600">{{ students[0].student.estimated_pickup_time }}</span>
                                {% endif %}
                            </span>
                            <button onclick="completeLocationGroup('{{ time_key }}', '{{ location }}')"
                                    class="text-xs bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded-lg transition-colors">
                                ì¥ì†Œ ì™„ë£Œ
                            </button>
                        </div>
                        
                        <!-- í•™ìƒë“¤ì„ ì¢Œìš°ë¡œ ë‚˜ì—´ -->
                        <div class="flex flex-wrap gap-2 mb-6">
                            {% for student_data in students %}
                                {% set student = student_data.student %}
                                {% set attendance = student_data.attendance %}
                                {% set request = student_data.request %}
                                
                                {% if request and request.status == 'approved' %}
                                    <!-- ìŠ¹ì¸ëœ ìš”ì²­ (ë¹„í™œì„±í™”) -->
                                    <div class="inline-flex items-center bg-gray-100 border-2 border-gray-300 rounded-xl px-3 py-2">
                                        <button onclick="showRequestInfo('{{ student.name }}', '{{ request.request_type }}', '{{ request.reason or '' }}')"
                                                class="text-sm font-medium text-gray-600">
                                            {{ student.name }}
                                        </button>
                                        <span class="text-sm ml-2">
                                            {% if request.request_type == 'absence' %}âŒ{% endif %}
                                            {% if request.request_type == 'pickup_skip' %}ğŸ {% endif %}
                                            {% if request.request_type == 'dropoff_skip' %}ğŸ«{% endif %}
                                        </span>
                                    </div>
                                {% elif attendance and attendance.pickup_status == 'boarded' %}
                                    <!-- ì´ë¯¸ íƒ‘ìŠ¹í•œ í•™ìƒ (í´ë¦­í•˜ë©´ ì·¨ì†Œ) -->
                                    <div class="inline-flex items-center bg-green-100 border-2 border-green-300 rounded-xl px-3 py-2 min-w-0">
                                        <button onclick="boardStudent({{ student.id }}, '{{ today }}')"
                                                class="text-sm font-semibold text-green-800 min-w-[50px] text-left"
                                                data-student-id="{{ student.id }}">
                                            {{ student.name }}
                                            {% if student.memo %}
                                                <span class="text-xs text-green-600 ml-1">({{ student.memo }})</span>
                                            {% endif %}
                                        </button>
                                        <button onclick="markAbsent({{ student.id }}, '{{ today }}')"
                                                class="text-red-500 hover:text-red-700 text-sm ml-2 w-5 h-5 flex items-center justify-center hover:bg-red-100 rounded transition-colors">
                                            âœ•
                                        </button>
                                    </div>
                                {% elif attendance and attendance.pickup_status == 'absent' %}
                                    <!-- ê²°ì„ ì²˜ë¦¬ëœ í•™ìƒ (X ë²„íŠ¼ìœ¼ë¡œ ì·¨ì†Œ) -->
                                    <div class="inline-flex items-center bg-red-100 border-2 border-red-300 rounded-xl px-3 py-2 min-w-0">
                                        <span class="text-sm font-semibold text-red-700 min-w-[50px] text-left">
                                            {{ student.name }}
                                            {% if student.memo %}
                                                <span class="text-xs text-red-600 ml-1">({{ student.memo }})</span>
                                            {% endif %}
                                        </span>
                                        <button onclick="markAbsent({{ student.id }}, '{{ today }}')"
                                                class="text-red-500 hover:text-red-700 text-sm ml-2 w-5 h-5 flex items-center justify-center hover:bg-red-100 rounded transition-colors">
                                            âœ•
                                        </button>
                                    </div>
                                {% else %}
                                    <!-- ëŒ€ê¸° ì¤‘ì¸ í•™ìƒ -->
                                    <div class="inline-flex items-center bg-white border-2 border-gray-300 rounded-xl px-3 py-2 hover:border-blue-400 transition-colors min-w-0">
                                        <button onclick="boardStudent({{ student.id }}, '{{ today }}')"
                                                class="text-sm font-medium text-gray-900 min-w-[50px] text-left"
                                                data-student-id="{{ student.id }}">
                                            {{ student.name }}
                                            {% if student.memo %}
                                                <span class="text-xs text-gray-600 ml-1">({{ student.memo }})</span>
                                            {% endif %}
                                        </button>
                                        <button onclick="contactParent({{ student.id }}, '{{ student.name }}')"
                                                class="text-blue-400 hover:text-blue-600 text-sm ml-1 w-5 h-5 flex items-center justify-center hover:bg-blue-100 rounded transition-colors"
                                                title="ë¶€ëª¨ë‹˜ê»˜ ì—°ë½">
                                            ğŸ“
                                        </button>
                                        <button onclick="markAbsent({{ student.id }}, '{{ today }}')"
                                                class="text-red-400 hover:text-red-600 text-sm ml-1 w-5 h-5 flex items-center justify-center hover:bg-red-100 rounded transition-colors">
                                            âœ•
                                        </button>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}

                    <!-- ì „ì²´ ì™„ë£Œ ë²„íŠ¼ -->
                    <div class="flex justify-center pt-6 mt-6 border-t border-gray-200">
                        <button onclick="completeAllInTimeSlot('{{ time_key }}')"
                                class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-semibold py-4 px-12 rounded-2xl shadow-lg transition-all duration-200 transform hover:scale-105">
                            ì „ì²´ ì™„ë£Œ
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <!-- ìŠ¤ì¼€ì¤„ì´ ì—†ëŠ” ê²½ìš° -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-8 text-center">
            <div class="text-gray-400 mb-4 text-3xl">ğŸ“…</div>
            <h2 class="text-xl font-semibold text-gray-900 mb-3">ì˜¤ëŠ˜ì€ ìš´í–‰ ìŠ¤ì¼€ì¤„ì´ ì—†ìŠµë‹ˆë‹¤</h2>
            <p class="text-base text-gray-600">íœ´ë¬´ì¼ì´ê±°ë‚˜ ë³„ë„ ìŠ¤ì¼€ì¤„ì´ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
        </div>
    {% endif %}
</div>

<!-- ìš”ì²­ ì •ë³´ ëª¨ë‹¬ -->
<div id="requestModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg p-6 w-full max-w-sm">
        <h3 class="text-lg font-semibold mb-4">ìš”ì²­ ì •ë³´</h3>
        <div id="requestContent" class="text-sm text-gray-600 mb-4"></div>
        <button onclick="closeRequestModal()" class="w-full btn-primary">
            í™•ì¸
        </button>
    </div>
</div>

<script>
let currentSlideIndex = 0;
const timeSlots = {{ time_groups.keys() | list | tojson | safe }};

function scrollToTimeSlot(timeKey) {
    // ëª¨ë“  ìŠ¬ë¼ì´ë“œ ìˆ¨ê¸°ê¸°
    document.querySelectorAll('.slide-item').forEach(slide => {
        slide.style.display = 'none';
    });
    
    // ì„ íƒëœ ìŠ¬ë¼ì´ë“œë§Œ ë³´ì´ê¸°
    const targetSlot = document.getElementById('slot-' + timeKey);
    if (targetSlot) {
        targetSlot.style.display = 'block';
        
        // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ í™œì„±í™” í‘œì‹œ
        document.querySelectorAll('[id^="nav-"]').forEach(btn => {
            btn.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
            btn.classList.add('bg-white', 'border-gray-300', 'text-gray-900');
        });
        const navBtn = document.getElementById('nav-' + timeKey);
        if (navBtn) {
            navBtn.classList.remove('bg-white', 'border-gray-300', 'text-gray-900');
            navBtn.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
        }
        
        currentSlideIndex = timeSlots.indexOf(timeKey);
        updateArrowStates();
        
        // í˜„ì¬ ì‹œê°„ëŒ€ë¥¼ localStorageì— ì €ì¥ (ìƒˆë¡œê³ ì¹¨ ëŒ€ì‘)
        const today = '{{ today }}';
        localStorage.setItem(`currentTimeSlot_${today}`, timeKey);
        
        // í˜„ì¬ ë²„íŠ¼ì„ ì •í™•íˆ ì¤‘ì•™ìœ¼ë¡œ ìŠ¤í¬ë¡¤ (í™”ì‚´í‘œì— ê°€ë ¤ì§€ì§€ ì•Šê²Œ)
        if (navBtn) {
            // scrollIntoView ì‚¬ìš©ìœ¼ë¡œ í™•ì‹¤í•˜ê²Œ ì¤‘ì•™ ì •ë ¬
            navBtn.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'nearest', 
                inline: 'center' 
            });
        }
    }
}

function nextSlide() {
    if (currentSlideIndex < timeSlots.length - 1) {
        currentSlideIndex++;
        scrollToTimeSlot(timeSlots[currentSlideIndex]);
    }
}

function previousSlide() {
    if (currentSlideIndex > 0) {
        currentSlideIndex--;
        scrollToTimeSlot(timeSlots[currentSlideIndex]);
    }
}

function updateArrowStates() {
    const prevBtn = document.querySelector('[onclick="previousSlide()"]');
    const nextBtn = document.querySelector('[onclick="nextSlide()"]');
    
    if (prevBtn) {
        if (currentSlideIndex <= 0) {
            prevBtn.classList.add('opacity-50', 'cursor-not-allowed');
            prevBtn.disabled = true;
        } else {
            prevBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            prevBtn.disabled = false;
        }
    }
    
    if (nextBtn) {
        if (currentSlideIndex >= timeSlots.length - 1) {
            nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
            nextBtn.disabled = true;
        } else {
            nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            nextBtn.disabled = false;
        }
    }
}

function boardStudent(studentId, date) {
    // í˜„ì¬ ì‹œê°„ëŒ€ ì €ì¥
    const currentTimeKey = timeSlots[currentSlideIndex];
    
    fetch('/api/update_attendance', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            student_id: studentId,
            date: date,
            status: 'boarded',
            type: 'pickup'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // í˜„ì¬ ì‹œê°„ëŒ€ë¥¼ ìœ ì§€í•˜ë©´ì„œ ìƒˆë¡œê³ ì¹¨
            window.location.href = window.location.pathname + '?time=' + encodeURIComponent(currentTimeKey);
        }
    });
}

function markAbsent(studentId, date) {
    // í˜„ì¬ ì‹œê°„ëŒ€ ì €ì¥
    const currentTimeKey = timeSlots[currentSlideIndex];
    
    fetch('/api/update_attendance', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            student_id: studentId,
            date: date,
            status: 'absent',
            type: 'pickup'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // í˜„ì¬ ì‹œê°„ëŒ€ë¥¼ ìœ ì§€í•˜ë©´ì„œ ìƒˆë¡œê³ ì¹¨
            window.location.href = window.location.pathname + '?time=' + encodeURIComponent(currentTimeKey);
        }
    });
}

function completeAllInTimeSlot(timeKey) {
    const timeSlot = document.getElementById('slot-' + timeKey);
    const pendingButtons = timeSlot.querySelectorAll('[data-student-id]');
    
    let completedCount = 0;
    const totalCount = pendingButtons.length;
    
    if (totalCount === 0) {
        // ëŒ€ê¸° ì¤‘ì¸ í•™ìƒì´ ì—†ìœ¼ë©´ ë°”ë¡œ ë‹¤ìŒ ì‹œê°„ìœ¼ë¡œ ì´ë™
        if (currentSlideIndex < timeSlots.length - 1) {
            nextSlide();
        }
        return;
    }
    
    pendingButtons.forEach(button => {
        const studentId = button.getAttribute('data-student-id');
        if (studentId) {
            fetch('/api/update_attendance', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    student_id: studentId,
                    date: '{{ today }}',
                    status: 'boarded',
                    type: 'pickup'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    completedCount++;
                    if (completedCount === totalCount) {
                        // ëª¨ë“  ìš”ì²­ì´ ì™„ë£Œë˜ë©´ ë‹¤ìŒ ì‹œê°„ìœ¼ë¡œ ì´ë™
                        setTimeout(() => {
                            if (currentSlideIndex < timeSlots.length - 1) {
                                currentSlideIndex++;
                                const nextTimeKey = timeSlots[currentSlideIndex];
                                window.location.href = window.location.pathname + '?time=' + encodeURIComponent(nextTimeKey);
                            } else {
                                location.reload();
                            }
                        }, 300);
                    }
                }
            });
        }
    });
}

function completeLocationGroup(timeKey, location) {
    const timeSlot = document.getElementById('slot-' + timeKey);
    if (!timeSlot) return;
    
    // í•´ë‹¹ ì¥ì†Œì˜ ëª¨ë“  í•™ìƒ ë²„íŠ¼ ì°¾ê¸°
    const locationSections = timeSlot.querySelectorAll('.mb-8');
    let targetButtons = [];
    
    locationSections.forEach(section => {
        const locationHeader = section.querySelector('span');
        if (locationHeader && locationHeader.textContent.includes(location)) {
            const buttons = section.querySelectorAll('[data-student-id]');
            buttons.forEach(button => {
                const studentId = button.getAttribute('data-student-id');
                if (studentId) {
                    targetButtons.push(studentId);
                }
            });
        }
    });
    
    if (targetButtons.length === 0) {
        alert('ì™„ë£Œí•  í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    let completedCount = 0;
    const totalCount = targetButtons.length;
    
    targetButtons.forEach(studentId => {
        fetch('/api/update_attendance', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                student_id: studentId,
                date: '{{ today }}',
                status: 'boarded',
                type: 'pickup'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                completedCount++;
                if (completedCount === totalCount) {
                    // í˜„ì¬ ì‹œê°„ëŒ€ë¥¼ ìœ ì§€í•˜ë©´ì„œ ìƒˆë¡œê³ ì¹¨
                    const currentTimeKey = timeSlots[currentSlideIndex];
                    window.location.href = window.location.pathname + '?time=' + encodeURIComponent(currentTimeKey);
                }
            }
        });
    });
}

function approveRequest(requestId) {
    if (confirm('ì´ ìš”ì²­ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        fetch(`/api/approve_request/${requestId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }
}

function approveAllRequests() {
    if (confirm('ëª¨ë“  ëŒ€ê¸° ì¤‘ì¸ ìš”ì²­ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        const approveButtons = document.querySelectorAll('[onclick^="approveRequest"]');
        approveButtons.forEach(button => {
            const requestId = button.getAttribute('onclick').match(/\d+/)[0];
            fetch(`/api/approve_request/${requestId}`, { 
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
        });
        
        setTimeout(() => {
            location.reload();
        }, 1000);
    }
}

function showRequestInfo(studentName, requestType, reason) {
    const types = {
        'absence': 'ê²°ì„',
        'pickup_skip': 'ì§ì ‘ ë“±ì›',
        'dropoff_skip': 'ë„ì¥ í”½ì—…'
    };
    
    document.getElementById('requestContent').innerHTML = `
        <p><strong>í•™ìƒ:</strong> ${studentName}</p>
        <p><strong>ìœ í˜•:</strong> ${types[requestType] || requestType}</p>
        ${reason ? `<p><strong>ì‚¬ìœ :</strong> ${reason}</p>` : ''}
    `;
    document.getElementById('requestModal').classList.remove('hidden');
}

function closeRequestModal() {
    document.getElementById('requestModal').classList.add('hidden');
}

// ì‹œê°„ëŒ€ë³„ ë©”ëª¨ ê¸°ëŠ¥
function toggleTimeSlotMemo(timeKey) {
    const memoDiv = document.getElementById('memo-' + timeKey);
    const memoInput = document.getElementById('memo-input-' + timeKey);
    
    if (memoDiv.classList.contains('hidden')) {
        memoDiv.classList.remove('hidden');
        // ì €ì¥ëœ ë©”ëª¨ ë¶ˆëŸ¬ì˜¤ê¸°
        loadTimeSlotMemo(timeKey);
        memoInput.focus();
    } else {
        memoDiv.classList.add('hidden');
    }
}

function saveTimeSlotMemo(timeKey, memoText) {
    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ (ì˜¤ëŠ˜ ë‚ ì§œì™€ í•¨ê»˜)
    const today = '{{ today }}';
    const key = `memo_${today}_${timeKey}`;
    localStorage.setItem(key, memoText);
}

function loadTimeSlotMemo(timeKey) {
    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
    const today = '{{ today }}';
    const key = `memo_${today}_${timeKey}`;
    const memoText = localStorage.getItem(key) || '';
    const memoInput = document.getElementById('memo-input-' + timeKey);
    if (memoInput) {
        memoInput.value = memoText;
    }
}

function clearTimeSlotMemo(timeKey) {
    if (confirm('ì´ ì‹œê°„ëŒ€ ë©”ëª¨ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        const today = '{{ today }}';
        const key = `memo_${today}_${timeKey}`;
        localStorage.removeItem(key);
        const memoInput = document.getElementById('memo-input-' + timeKey);
        if (memoInput) {
            memoInput.value = '';
        }
    }
}

// ë¶€ëª¨ë‹˜ì—ê²Œ ì—°ë½í•˜ê¸° ê¸°ëŠ¥
function contactParent(studentId, studentName) {
    const contactOptions = [
        { type: 'phone', label: 'ğŸ“ ì „í™” ì—°ê²°', message: 'í•™ìƒ ë„ì°© ì‹œê°„ ì•ˆë‚´' },
        { type: 'kakao', label: 'ğŸ’¬ ì¹´ì¹´ì˜¤í†¡ ì•Œë¦¼', message: 'ì°¨ëŸ‰ ìš´í–‰ ì•Œë¦¼' }
    ];
    
    let optionsHTML = contactOptions.map((option, index) => 
        `<button onclick="executeContact(${studentId}, '${studentName}', '${option.type}')" 
                 class="w-full p-3 text-left border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors mb-2">
            <div class="font-medium">${option.label}</div>
            <div class="text-sm text-gray-600">${option.message}</div>
         </button>`
    ).join('');
    
    // ê°„ë‹¨í•œ ëª¨ë‹¬ ëŒ€ì‹  ì»¨íŒìœ¼ë¡œ ëŒ€ì²´ (ì¼ë‹¨ í…ŒìŠ¤íŠ¸ìš©)
    if (confirm(`${studentName} í•™ìƒ ë¶€ëª¨ë‹˜ê»˜ ì—°ë½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì•ˆì‹¬ë²ˆí˜¸ ì„œë¹„ìŠ¤ëŠ” ê°œë°œ ì¤‘ì…ë‹ˆë‹¤.\ní˜„ì¬ëŠ” ì‹œë®¬ë ˆì´ì…˜ë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤.`)) {
        executeContact(studentId, studentName, 'phone');
    }
}

function executeContact(studentId, studentName, contactType) {
    fetch('/api/contact_parent', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            student_id: studentId,
            type: contactType,
            message: `${studentName} í•™ìƒ ì°¨ëŸ‰ ìš´í–‰ ê´€ë ¨ ì—°ë½ë“œë¦½ë‹ˆë‹¤.`
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.action === 'call' && data.contacts) {
                // ì „í™” ì—°ê²° ì˜µì…˜ í‘œì‹œ
                showCallOptions(studentName, data.contacts);
            } else if (data.action === 'kakao') {
                // ì¹´ì¹´ì˜¤í†¡ ì‹œë®¬ë ˆì´ì…˜ í‘œì‹œ
                alert(`ğŸ“± ${data.message}\n\në¯¸ë¦¬ë³´ê¸°:\n${data.preview}\n\nâš ï¸ ${data.note}`);
            }
        } else {
            alert(`âŒ ì—°ë½ ì‹¤íŒ¨: ${data.error}`);
        }
    })
            .catch(error => {
            console.error('Error:', error);
            showNotification('ì—°ë½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        });
}

function showCallOptions(studentName, contacts) {
    // ì—°ë½ì²˜ ì˜µì…˜ì„ ë³´ì—¬ì£¼ëŠ” ê°„ë‹¨í•œ ì„ íƒì°½
    let options = contacts.map((contact, index) => 
        `${index + 1}. ${contact.type}: ${contact.number}`
    ).join('\n');
    
    let choice = prompt(`${studentName} í•™ìƒ ë¶€ëª¨ë‹˜ê»˜ ì „í™”í•˜ê¸°\n\nì—°ë½ì²˜ë¥¼ ì„ íƒí•˜ì„¸ìš”:\n${options}\n\në²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (1-${contacts.length}):`);
    
    if (choice && choice >= 1 && choice <= contacts.length) {
        let selectedContact = contacts[choice - 1];
        // ì‹¤ì œ ì „í™” ì•±ìœ¼ë¡œ ì—°ê²°
        window.location.href = selectedContact.tel_link;
    }
}

// ë¹ ë¥¸ ì „í™”ê±¸ê¸° ê¸°ëŠ¥ (ì •ì„ êµ¬í˜„)
function quickCall(type, location = null, customNumber = null) {
    fetch('/api/quick_call', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            type: type,
            location: location,
            number: customNumber
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.action === 'call') {
                if (confirm(`${data.display}ì— ì „í™”ë¥¼ ê±¸ê¹Œìš”?`)) {
                    window.location.href = data.tel_link;
                }
            } else if (data.action === 'select') {
                showCallOptions(data.options, data.message);
            }
        } else {
            alert(`âŒ ì˜¤ë¥˜: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('âŒ ì „í™” ì—°ê²° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// ì—¬ëŸ¬ ì—°ë½ì²˜ ì˜µì…˜ í‘œì‹œ
function showCallOptions(options, title) {
    let optionsText = options.map((option, index) => 
        `${index + 1}. ${option.name} (${option.phone_number})`
    ).join('\n');
    
    let choice = prompt(`${title}\n\n${optionsText}\n\në²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš” (1-${options.length}):`);
    
    if (choice && choice >= 1 && choice <= options.length) {
        let selectedOption = options[choice - 1];
        if (confirm(`${selectedOption.name} (${selectedOption.phone_number})ì— ì „í™”ë¥¼ ê±¸ê¹Œìš”?`)) {
            window.location.href = selectedOption.tel_link;
        }
    }
}

// ë¹ ë¥¸ ì „í™” ë²„íŠ¼ë“¤ ë¡œë“œ
function loadQuickCallButtons(timeKey, location = null) {
    const container = document.getElementById(`quickCallButtons-${timeKey}`);
    if (!container) return;
    
    fetch(`/api/quick_call_numbers?location=${location || ''}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayQuickCallButtons(container, data.numbers, location);
        }
    })
    .catch(error => {
        console.error('Error loading quick call buttons:', error);
        // ê¸°ë³¸ ë²„íŠ¼ë“¤ í‘œì‹œ
        container.innerHTML = `
            <button onclick="quickCall('school')" 
                    class="text-xs bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded transition-colors">
                ğŸ« í•™êµ
            </button>
            <button onclick="quickCall('daycare')" 
                    class="text-xs bg-orange-500 hover:bg-orange-600 text-white px-2 py-1 rounded transition-colors">
                ğŸ‘¶ ëŒë´„
            </button>
            <button onclick="quickCall('emergency')" 
                    class="text-xs bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded transition-colors">
                ğŸš¨ ì‘ê¸‰
            </button>
        `;
    });
}

// ë¹ ë¥¸ ì „í™” ë²„íŠ¼ë“¤ í‘œì‹œ
function displayQuickCallButtons(container, numbers, location) {
    const categoryColors = {
        'school': 'bg-green-500 hover:bg-green-600',
        'daycare': 'bg-orange-500 hover:bg-orange-600', 
        'emergency': 'bg-red-500 hover:bg-red-600',
        'location': 'bg-blue-500 hover:bg-blue-600',
        'custom': 'bg-gray-500 hover:bg-gray-600'
    };
    
    const categoryIcons = {
        'school': 'ğŸ«',
        'daycare': 'ğŸ‘¶',
        'emergency': 'ğŸš¨',
        'location': 'ğŸ“',
        'custom': 'âš™ï¸'
    };
    
    const categoryNames = {
        'school': 'í•™êµ',
        'daycare': 'ëŒë´„',
        'emergency': 'ì‘ê¸‰',
        'location': 'ì¥ì†Œ',
        'custom': 'ê¸°íƒ€'
    };
    
    let buttonsHTML = '';
    
    // ìš°ì„ ìˆœìœ„ ë†’ì€ ì¹´í…Œê³ ë¦¬ ìˆœì„œëŒ€ë¡œ í‘œì‹œ
    const priorityOrder = ['emergency', 'school', 'daycare', 'location', 'custom'];
    
    priorityOrder.forEach(category => {
        if (numbers[category] && numbers[category].length > 0) {
            const colorClass = categoryColors[category] || 'bg-gray-500 hover:bg-gray-600';
            const icon = categoryIcons[category] || 'ğŸ“';
            const name = categoryNames[category] || category;
            
            buttonsHTML += `
                <button onclick="quickCall('${category}', '${location || ''}')" 
                        class="text-xs ${colorClass} text-white px-2 py-1 rounded transition-colors"
                        title="${numbers[category].length}ê°œì˜ ${name} ì—°ë½ì²˜">
                    ${icon} ${name}
                </button>
            `;
        }
    });
    
    container.innerHTML = buttonsHTML || `
        <span class="text-xs text-gray-500">ë“±ë¡ëœ ë¹ ë¥¸ ì „í™”ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤</span>
    `;
}

// ì´ˆê¸° ìŠ¬ë¼ì´ë“œ ì„¤ì • (ìƒˆë¡œê³ ì¹¨ ì‹œ í˜„ì¬ ìœ„ì¹˜ ìœ ì§€)
document.addEventListener('DOMContentLoaded', function() {
    if (timeSlots.length > 0) {
        const urlParams = new URLSearchParams(window.location.search);
        const timeParam = urlParams.get('time');
        const today = '{{ today }}';
        const savedTimeSlot = localStorage.getItem(`currentTimeSlot_${today}`);
        
        // ìš°ì„ ìˆœìœ„: URL íŒŒë¼ë¯¸í„° > ì €ì¥ëœ ì‹œê°„ëŒ€ > ì²« ë²ˆì§¸ ì‹œê°„ëŒ€
        let targetTimeSlot = null;
        if (timeParam && timeSlots.includes(timeParam)) {
            targetTimeSlot = timeParam;
        } else if (savedTimeSlot && timeSlots.includes(savedTimeSlot)) {
            targetTimeSlot = savedTimeSlot;
        } else {
            targetTimeSlot = timeSlots[0];
        }
        
        scrollToTimeSlot(targetTimeSlot);
        updateArrowStates();
        
        // ê° ì‹œê°„ëŒ€ë³„ë¡œ ë¹ ë¥¸ ì „í™” ë²„íŠ¼ ë¡œë“œ
        timeSlots.forEach(timeKey => {
            loadQuickCallButtons(timeKey);
        });
    }
    
    // ì €ì¥ëœ ë©”ëª¨ê°€ ìˆìœ¼ë©´ í‘œì‹œ
    timeSlots.forEach(timeKey => {
        const today = '{{ today }}';
        const key = `memo_${today}_${timeKey}`;
        const savedMemo = localStorage.getItem(key);
        if (savedMemo && savedMemo.trim()) {
            // ë©”ëª¨ê°€ ìˆìœ¼ë©´ ğŸ“ ì•„ì´ì½˜ì„ ë…¸ë€ìƒ‰ìœ¼ë¡œ í‘œì‹œ
            const button = document.querySelector(`button[onclick="toggleTimeSlotMemo('${timeKey}')"]`);
            if (button) {
                button.classList.add('text-yellow-600');
                button.classList.remove('text-gray-500');
            }
        }
    });
    
    // ì´ì „ ë‚ ì§œì˜ ë©”ëª¨ë“¤ê³¼ ì‹œê°„ëŒ€ ì •ë³´ ìë™ ì •ë¦¬ (ì¼ì£¼ì¼ ì´ì „)
    const oneWeekAgo = new Date();
    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
    
    Object.keys(localStorage).forEach(key => {
        if (key.startsWith('memo_') || key.startsWith('currentTimeSlot_')) {
            const dateStr = key.split('_')[1];
            if (dateStr && new Date(dateStr) < oneWeekAgo) {
                localStorage.removeItem(key);
            }
        }
    });
});
</script>

{% endblock %} 