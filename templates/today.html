{% extends "base.html" %}

{% block page_title %}ì˜¤ëŠ˜ ìš´í–‰ í˜„í™©{% endblock %}

{% block content %}
<div class="px-4 py-6">
    <!-- ëŒ€ê¸° ì¤‘ì¸ ìš”ì²­ ì•Œë¦¼ -->
    {% set pending_requests = [] %}
    {% for time_key, locations in time_groups.items() %}
        {% for location, students in locations.items() %}
            {% for student_data in students %}
                {% if student_data.request and student_data.request.status == 'pending' %}
                    {% set _ = pending_requests.append(student_data.request) %}
                {% endif %}
            {% endfor %}
        {% endfor %}
    {% endfor %}

    {% if pending_requests %}
        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-6">
            <h3 class="text-sm font-semibold text-orange-800 mb-3">ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ìš”ì²­ ({{ pending_requests|length }}ê±´)</h3>
            {% for request in pending_requests %}
            <div class="bg-orange-100 border border-orange-300 rounded-lg p-3">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <span class="text-sm font-medium text-orange-800">{{ request.student.name }}</span>
                        <span class="text-xs text-orange-600 ml-2">
                            {% if request.request_type == 'absence' %}ê²°ì„ ìš”ì²­{% endif %}
                            {% if request.request_type == 'pickup_skip' %}ì§ì ‘ë“±ì› ìš”ì²­{% endif %}
                            {% if request.request_type == 'dropoff_skip' %}ë„ì¥í”½ì—… ìš”ì²­{% endif %}
                        </span>
                    </div>
                    <button onclick="approveRequest({{ request.id }})"
                            class="bg-orange-600 hover:bg-orange-700 text-white text-xs px-3 py-1 rounded">
                        ìŠ¹ì¸
                    </button>
                </div>
            </div>
            {% endfor %}
            
            {% if pending_requests|length > 1 %}
            <button onclick="approveAllRequests()" 
                    class="w-full bg-orange-600 hover:bg-orange-700 text-white text-sm py-2 rounded-lg">
                ëª¨ë“  ìš”ì²­ ì¼ê´„ ìŠ¹ì¸
            </button>
            {% endif %}
        </div>
    {% endif %}

    {% if time_groups %}
        <!-- ì‹œê°„ëŒ€ ë„¤ë¹„ê²Œì´ì…˜ (í™”ì‚´í‘œ ê³ ì •, ì‹œê°„ ë²„íŠ¼ ì¤‘ì•™ ì •ë ¬) -->
        <div class="relative mb-6">
            <div class="flex items-center">
                <!-- ì™¼ìª½ í™”ì‚´í‘œ (ê³ ì •) -->
                <button onclick="previousSlide()" 
                        class="flex-shrink-0 w-10 h-10 bg-white hover:bg-gray-50 flex items-center justify-center text-lg border border-gray-300 rounded-xl shadow-sm z-10 mr-3 transition-colors">
                    â¬…ï¸
                </button>
                
                <!-- ì‹œê°„ ë²„íŠ¼ë“¤ (ì¤‘ì•™ ì •ë ¬, ìŠ¤í¬ë¡¤ ê°€ëŠ¥) -->
                <div class="flex-1 overflow-x-auto scrollbar-hide" id="timeNavContainer">
                    <div class="flex space-x-3 px-2">
                        {% for time_key in time_groups.keys() %}
                        <button onclick="scrollToTimeSlot('{{ time_key }}')" id="nav-{{ time_key }}"
                                class="flex-shrink-0 px-3 py-2 text-xs font-semibold bg-white border border-gray-300 rounded-xl hover:bg-gray-50 transition-all duration-200 shadow-sm whitespace-nowrap">
                            {{ time_key.replace(' PM', '') }}
                        </button>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- ì˜¤ë¥¸ìª½ í™”ì‚´í‘œ (ê³ ì •) -->
                <button onclick="nextSlide()" 
                        class="flex-shrink-0 w-10 h-10 bg-white hover:bg-gray-50 flex items-center justify-center text-lg border border-gray-300 rounded-xl shadow-sm z-10 ml-3 transition-colors">
                    â¡ï¸
                </button>
            </div>
        </div>

        <!-- ì‹œê°„ëŒ€ë³„ ìŠ¬ë¼ì´ë“œ -->
        <div class="space-y-6" id="timeSlides">
            {% for time_key, locations in time_groups.items() %}
            <div class="slide-item" id="slot-{{ time_key }}" style="display: none;">
                <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-6">
                    <!-- ì‹œê°„ëŒ€ í—¤ë” -->
                    <div class="mb-6 text-center">
                        <div class="flex items-center justify-center mb-2">
                            <h2 class="text-2xl font-bold text-gray-900">{{ time_key }}</h2>
                            <button onclick="toggleTimeSlotMemo('{{ time_key }}')" 
                                    class="ml-3 p-1 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded transition-colors"
                                    title="ì‹œê°„ëŒ€ ë©”ëª¨">
                                ğŸ“
                            </button>
                        </div>
                        <div class="w-16 h-1 bg-blue-500 rounded-full mx-auto"></div>
                        
                        <!-- ì‹œê°„ëŒ€ë³„ ë©”ëª¨ -->
                        <div id="memo-{{ time_key }}" class="mt-4 hidden">
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 max-w-md mx-auto">
                                <textarea 
                                    id="memo-input-{{ time_key }}"
                                    placeholder="ì„ì‹œ í•™ìƒì´ë‚˜ íŠ¹ì´ì‚¬í•­ì„ ë©”ëª¨í•˜ì„¸ìš”..."
                                    class="w-full bg-white border border-yellow-300 rounded px-3 py-2 text-sm resize-none focus:ring-yellow-500 focus:border-yellow-500"
                                    rows="3"
                                    onchange="saveTimeSlotMemo('{{ time_key }}', this.value)"></textarea>
                                <div class="flex justify-between items-center mt-2">
                                    <span class="text-xs text-yellow-600">ğŸ’¡ ì¼íšŒì„± ë©”ëª¨ (ë‚´ì¼ ì´ˆê¸°í™”ë¨)</span>
                                    <button onclick="clearTimeSlotMemo('{{ time_key }}')" 
                                            class="text-xs text-red-500 hover:text-red-700">ì§€ìš°ê¸°</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ì¥ì†Œë³„ë¡œ ê·¸ë£¹í™”ëœ í•™ìƒ ëª©ë¡ -->
                    {% for location, students in locations.items() %}
                    <div class="mb-8 last:mb-0">
                        <div class="flex items-center justify-between mb-4">
                            <span class="text-sm font-semibold text-gray-700 bg-gray-100 px-3 py-1 rounded-lg">
                                {{ location }}
                                {% if students[0].student.estimated_pickup_time %}
                                    <span class="ml-2 text-xs text-gray-600">{{ students[0].student.estimated_pickup_time }}</span>
                                {% endif %}
                            </span>
                            <button onclick="completeLocationGroup('{{ time_key }}', '{{ location }}')"
                                    class="text-xs bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded-lg transition-colors">
                                ì¥ì†Œ ì™„ë£Œ
                            </button>
                        </div>
                        
                        <!-- í•™ìƒë“¤ì„ ì¢Œìš°ë¡œ ë‚˜ì—´ -->
                        <div class="flex flex-wrap gap-2 mb-6">
                            {% for student_data in students %}
                                {% set student = student_data.student %}
                                {% set attendance = student_data.attendance %}
                                {% set request = student_data.request %}
                                
                                {% if request and request.status == 'approved' %}
                                    <!-- ìŠ¹ì¸ëœ ìš”ì²­ (ë¹„í™œì„±í™”) -->
                                    <div class="inline-flex items-center bg-gray-100 border-2 border-gray-300 rounded-xl px-3 py-2">
                                        <button onclick="showRequestInfo('{{ student.name }}', '{{ request.request_type }}', '{{ request.reason or '' }}')"
                                                class="text-sm font-medium text-gray-600">
                                            {{ student.name }}
                                        </button>
                                        <span class="text-sm ml-2">
                                            {% if request.request_type == 'absence' %}âŒ{% endif %}
                                            {% if request.request_type == 'pickup_skip' %}ğŸ {% endif %}
                                            {% if request.request_type == 'dropoff_skip' %}ğŸ«{% endif %}
                                        </span>
                                    </div>
                                {% elif attendance and attendance.pickup_status == 'boarded' %}
                                    <!-- ì´ë¯¸ íƒ‘ìŠ¹í•œ í•™ìƒ (í´ë¦­í•˜ë©´ ì·¨ì†Œ) -->
                                    <div class="inline-flex items-center bg-green-100 border-2 border-green-300 rounded-xl px-3 py-2 min-w-0">
                                        <button onclick="boardStudent({{ student.id }}, '{{ today }}')"
                                                class="text-sm font-semibold text-green-800 min-w-[50px] text-left"
                                                data-student-id="{{ student.id }}">
                                            {{ student.name }}
                                            {% if student.memo %}
                                                <span class="text-xs text-green-600 ml-1">({{ student.memo }})</span>
                                            {% endif %}
                                        </button>
                                        <button onclick="markAbsent({{ student.id }}, '{{ today }}')"
                                                class="text-red-500 hover:text-red-700 text-sm ml-2 w-5 h-5 flex items-center justify-center hover:bg-red-100 rounded transition-colors">
                                            âœ•
                                        </button>
                                    </div>
                                {% elif attendance and attendance.pickup_status == 'absent' %}
                                    <!-- ê²°ì„ ì²˜ë¦¬ëœ í•™ìƒ (X ë²„íŠ¼ìœ¼ë¡œ ì·¨ì†Œ) -->
                                    <div class="inline-flex items-center bg-red-100 border-2 border-red-300 rounded-xl px-3 py-2 min-w-0">
                                        <span class="text-sm font-semibold text-red-700 min-w-[50px] text-left">
                                            {{ student.name }}
                                            {% if student.memo %}
                                                <span class="text-xs text-red-600 ml-1">({{ student.memo }})</span>
                                            {% endif %}
                                        </span>
                                        <button onclick="markAbsent({{ student.id }}, '{{ today }}')"
                                                class="text-red-500 hover:text-red-700 text-sm ml-2 w-5 h-5 flex items-center justify-center hover:bg-red-100 rounded transition-colors">
                                            âœ•
                                        </button>
                                    </div>
                                {% else %}
                                    <!-- ëŒ€ê¸° ì¤‘ì¸ í•™ìƒ -->
                                    <div class="inline-flex items-center bg-white border-2 border-gray-300 rounded-xl px-3 py-2 hover:border-blue-400 transition-colors min-w-0">
                                        <button onclick="boardStudent({{ student.id }}, '{{ today }}')"
                                                class="text-sm font-medium text-gray-900 min-w-[50px] text-left"
                                                data-student-id="{{ student.id }}">
                                            {{ student.name }}
                                            {% if student.memo %}
                                                <span class="text-xs text-gray-600 ml-1">({{ student.memo }})</span>
                                            {% endif %}
                                        </button>
                                        <button onclick="markAbsent({{ student.id }}, '{{ today }}')"
                                                class="text-red-400 hover:text-red-600 text-sm ml-2 w-5 h-5 flex items-center justify-center hover:bg-red-100 rounded transition-colors">
                                            âœ•
                                        </button>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}

                    <!-- ì „ì²´ ì™„ë£Œ ë²„íŠ¼ -->
                    <div class="flex justify-center pt-6 mt-6 border-t border-gray-200">
                        <button onclick="completeAllInTimeSlot('{{ time_key }}')"
                                class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-semibold py-4 px-12 rounded-2xl shadow-lg transition-all duration-200 transform hover:scale-105">
                            ì „ì²´ ì™„ë£Œ
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <!-- ìŠ¤ì¼€ì¤„ì´ ì—†ëŠ” ê²½ìš° -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-8 text-center">
            <div class="text-gray-400 mb-4 text-3xl">ğŸ“…</div>
            <h2 class="text-xl font-semibold text-gray-900 mb-3">ì˜¤ëŠ˜ì€ ìš´í–‰ ìŠ¤ì¼€ì¤„ì´ ì—†ìŠµë‹ˆë‹¤</h2>
            <p class="text-base text-gray-600">íœ´ë¬´ì¼ì´ê±°ë‚˜ ë³„ë„ ìŠ¤ì¼€ì¤„ì´ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
        </div>
    {% endif %}
</div>

<!-- ìš”ì²­ ì •ë³´ ëª¨ë‹¬ -->
<div id="requestModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg p-6 w-full max-w-sm">
        <h3 class="text-lg font-semibold mb-4">ìš”ì²­ ì •ë³´</h3>
        <div id="requestContent" class="text-sm text-gray-600 mb-4"></div>
        <button onclick="closeRequestModal()" class="w-full btn-primary">
            í™•ì¸
        </button>
    </div>
</div>

<script>
let currentSlideIndex = 0;
const timeSlots = {{ time_groups.keys() | list | tojson | safe }};

function scrollToTimeSlot(timeKey) {
    // ëª¨ë“  ìŠ¬ë¼ì´ë“œ ìˆ¨ê¸°ê¸°
    document.querySelectorAll('.slide-item').forEach(slide => {
        slide.style.display = 'none';
    });
    
    // ì„ íƒëœ ìŠ¬ë¼ì´ë“œë§Œ ë³´ì´ê¸°
    const targetSlot = document.getElementById('slot-' + timeKey);
    if (targetSlot) {
        targetSlot.style.display = 'block';
        
        // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ í™œì„±í™” í‘œì‹œ
        document.querySelectorAll('[id^="nav-"]').forEach(btn => {
            btn.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
            btn.classList.add('bg-white', 'border-gray-300', 'text-gray-900');
        });
        const navBtn = document.getElementById('nav-' + timeKey);
        if (navBtn) {
            navBtn.classList.remove('bg-white', 'border-gray-300', 'text-gray-900');
            navBtn.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
        }
        
        currentSlideIndex = timeSlots.indexOf(timeKey);
        updateArrowStates();
        
        // í˜„ì¬ ë²„íŠ¼ì„ ì¤‘ì•™ìœ¼ë¡œ ìŠ¤í¬ë¡¤ (ì»¨í…Œì´ë„ˆ ê¸°ì¤€)
        if (navBtn) {
            const container = document.getElementById('timeNavContainer');
            const containerRect = container.getBoundingClientRect();
            const buttonRect = navBtn.getBoundingClientRect();
            const scrollLeft = navBtn.offsetLeft - (container.offsetWidth / 2) + (navBtn.offsetWidth / 2);
            container.scrollTo({ left: scrollLeft, behavior: 'smooth' });
        }
    }
}

function nextSlide() {
    if (currentSlideIndex < timeSlots.length - 1) {
        currentSlideIndex++;
        scrollToTimeSlot(timeSlots[currentSlideIndex]);
    }
}

function previousSlide() {
    if (currentSlideIndex > 0) {
        currentSlideIndex--;
        scrollToTimeSlot(timeSlots[currentSlideIndex]);
    }
}

function updateArrowStates() {
    const prevBtn = document.querySelector('[onclick="previousSlide()"]');
    const nextBtn = document.querySelector('[onclick="nextSlide()"]');
    
    if (prevBtn) {
        if (currentSlideIndex <= 0) {
            prevBtn.classList.add('opacity-50', 'cursor-not-allowed');
            prevBtn.disabled = true;
        } else {
            prevBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            prevBtn.disabled = false;
        }
    }
    
    if (nextBtn) {
        if (currentSlideIndex >= timeSlots.length - 1) {
            nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
            nextBtn.disabled = true;
        } else {
            nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            nextBtn.disabled = false;
        }
    }
}

function boardStudent(studentId, date) {
    // í˜„ì¬ ì‹œê°„ëŒ€ ì €ì¥
    const currentTimeKey = timeSlots[currentSlideIndex];
    
    fetch('/api/update_attendance', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            student_id: studentId,
            date: date,
            status: 'boarded',
            type: 'pickup'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // í˜„ì¬ ì‹œê°„ëŒ€ë¥¼ ìœ ì§€í•˜ë©´ì„œ ìƒˆë¡œê³ ì¹¨
            window.location.href = window.location.pathname + '?time=' + encodeURIComponent(currentTimeKey);
        }
    });
}

function markAbsent(studentId, date) {
    // í˜„ì¬ ì‹œê°„ëŒ€ ì €ì¥
    const currentTimeKey = timeSlots[currentSlideIndex];
    
    fetch('/api/update_attendance', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            student_id: studentId,
            date: date,
            status: 'absent',
            type: 'pickup'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // í˜„ì¬ ì‹œê°„ëŒ€ë¥¼ ìœ ì§€í•˜ë©´ì„œ ìƒˆë¡œê³ ì¹¨
            window.location.href = window.location.pathname + '?time=' + encodeURIComponent(currentTimeKey);
        }
    });
}

function completeAllInTimeSlot(timeKey) {
    const timeSlot = document.getElementById('slot-' + timeKey);
    const pendingButtons = timeSlot.querySelectorAll('[data-student-id]');
    
    let completedCount = 0;
    const totalCount = pendingButtons.length;
    
    if (totalCount === 0) {
        // ëŒ€ê¸° ì¤‘ì¸ í•™ìƒì´ ì—†ìœ¼ë©´ ë°”ë¡œ ë‹¤ìŒ ì‹œê°„ìœ¼ë¡œ ì´ë™
        if (currentSlideIndex < timeSlots.length - 1) {
            nextSlide();
        }
        return;
    }
    
    pendingButtons.forEach(button => {
        const studentId = button.getAttribute('data-student-id');
        if (studentId) {
            fetch('/api/update_attendance', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    student_id: studentId,
                    date: '{{ today }}',
                    status: 'boarded',
                    type: 'pickup'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    completedCount++;
                    if (completedCount === totalCount) {
                        // ëª¨ë“  ìš”ì²­ì´ ì™„ë£Œë˜ë©´ ë‹¤ìŒ ì‹œê°„ìœ¼ë¡œ ì´ë™
                        setTimeout(() => {
                            if (currentSlideIndex < timeSlots.length - 1) {
                                currentSlideIndex++;
                                const nextTimeKey = timeSlots[currentSlideIndex];
                                window.location.href = window.location.pathname + '?time=' + encodeURIComponent(nextTimeKey);
                            } else {
                                location.reload();
                            }
                        }, 300);
                    }
                }
            });
        }
    });
}

function completeLocationGroup(timeKey, location) {
    const timeSlot = document.getElementById('slot-' + timeKey);
    if (!timeSlot) return;
    
    // í•´ë‹¹ ì¥ì†Œì˜ ëª¨ë“  í•™ìƒ ë²„íŠ¼ ì°¾ê¸°
    const locationSections = timeSlot.querySelectorAll('.mb-8');
    let targetButtons = [];
    
    locationSections.forEach(section => {
        const locationHeader = section.querySelector('span');
        if (locationHeader && locationHeader.textContent.includes(location)) {
            const buttons = section.querySelectorAll('[data-student-id]');
            buttons.forEach(button => {
                const studentId = button.getAttribute('data-student-id');
                if (studentId) {
                    targetButtons.push(studentId);
                }
            });
        }
    });
    
    if (targetButtons.length === 0) {
        alert('ì™„ë£Œí•  í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    let completedCount = 0;
    const totalCount = targetButtons.length;
    
    targetButtons.forEach(studentId => {
        fetch('/api/update_attendance', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                student_id: studentId,
                date: '{{ today }}',
                status: 'boarded',
                type: 'pickup'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                completedCount++;
                if (completedCount === totalCount) {
                    // í˜„ì¬ ì‹œê°„ëŒ€ë¥¼ ìœ ì§€í•˜ë©´ì„œ ìƒˆë¡œê³ ì¹¨
                    const currentTimeKey = timeSlots[currentSlideIndex];
                    window.location.href = window.location.pathname + '?time=' + encodeURIComponent(currentTimeKey);
                }
            }
        });
    });
}

function approveRequest(requestId) {
    if (confirm('ì´ ìš”ì²­ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        fetch(`/api/approve_request/${requestId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }
}

function approveAllRequests() {
    if (confirm('ëª¨ë“  ëŒ€ê¸° ì¤‘ì¸ ìš”ì²­ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        const approveButtons = document.querySelectorAll('[onclick^="approveRequest"]');
        approveButtons.forEach(button => {
            const requestId = button.getAttribute('onclick').match(/\d+/)[0];
            fetch(`/api/approve_request/${requestId}`, { 
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
        });
        
        setTimeout(() => {
            location.reload();
        }, 1000);
    }
}

function showRequestInfo(studentName, requestType, reason) {
    const types = {
        'absence': 'ê²°ì„',
        'pickup_skip': 'ì§ì ‘ ë“±ì›',
        'dropoff_skip': 'ë„ì¥ í”½ì—…'
    };
    
    document.getElementById('requestContent').innerHTML = `
        <p><strong>í•™ìƒ:</strong> ${studentName}</p>
        <p><strong>ìœ í˜•:</strong> ${types[requestType] || requestType}</p>
        ${reason ? `<p><strong>ì‚¬ìœ :</strong> ${reason}</p>` : ''}
    `;
    document.getElementById('requestModal').classList.remove('hidden');
}

function closeRequestModal() {
    document.getElementById('requestModal').classList.add('hidden');
}

// ì‹œê°„ëŒ€ë³„ ë©”ëª¨ ê¸°ëŠ¥
function toggleTimeSlotMemo(timeKey) {
    const memoDiv = document.getElementById('memo-' + timeKey);
    const memoInput = document.getElementById('memo-input-' + timeKey);
    
    if (memoDiv.classList.contains('hidden')) {
        memoDiv.classList.remove('hidden');
        // ì €ì¥ëœ ë©”ëª¨ ë¶ˆëŸ¬ì˜¤ê¸°
        loadTimeSlotMemo(timeKey);
        memoInput.focus();
    } else {
        memoDiv.classList.add('hidden');
    }
}

function saveTimeSlotMemo(timeKey, memoText) {
    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ (ì˜¤ëŠ˜ ë‚ ì§œì™€ í•¨ê»˜)
    const today = '{{ today }}';
    const key = `memo_${today}_${timeKey}`;
    localStorage.setItem(key, memoText);
}

function loadTimeSlotMemo(timeKey) {
    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
    const today = '{{ today }}';
    const key = `memo_${today}_${timeKey}`;
    const memoText = localStorage.getItem(key) || '';
    const memoInput = document.getElementById('memo-input-' + timeKey);
    if (memoInput) {
        memoInput.value = memoText;
    }
}

function clearTimeSlotMemo(timeKey) {
    if (confirm('ì´ ì‹œê°„ëŒ€ ë©”ëª¨ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        const today = '{{ today }}';
        const key = `memo_${today}_${timeKey}`;
        localStorage.removeItem(key);
        const memoInput = document.getElementById('memo-input-' + timeKey);
        if (memoInput) {
            memoInput.value = '';
        }
    }
}

// ì´ˆê¸° ìŠ¬ë¼ì´ë“œ ì„¤ì •
document.addEventListener('DOMContentLoaded', function() {
    if (timeSlots.length > 0) {
        const urlParams = new URLSearchParams(window.location.search);
        const timeParam = urlParams.get('time');
        
        if (timeParam && timeSlots.includes(timeParam)) {
            scrollToTimeSlot(timeParam);
        } else {
            scrollToTimeSlot(timeSlots[0]);
        }
        updateArrowStates();
    }
    
    // ì €ì¥ëœ ë©”ëª¨ê°€ ìˆìœ¼ë©´ í‘œì‹œ
    timeSlots.forEach(timeKey => {
        const today = '{{ today }}';
        const key = `memo_${today}_${timeKey}`;
        const savedMemo = localStorage.getItem(key);
        if (savedMemo && savedMemo.trim()) {
            // ë©”ëª¨ê°€ ìˆìœ¼ë©´ ğŸ“ ì•„ì´ì½˜ì„ ë…¸ë€ìƒ‰ìœ¼ë¡œ í‘œì‹œ
            const button = document.querySelector(`button[onclick="toggleTimeSlotMemo('${timeKey}')"]`);
            if (button) {
                button.classList.add('text-yellow-600');
                button.classList.remove('text-gray-500');
            }
        }
    });
    
    // ì´ì „ ë‚ ì§œì˜ ë©”ëª¨ë“¤ì€ ìë™ ì •ë¦¬ (ì¼ì£¼ì¼ ì´ì „)
    const oneWeekAgo = new Date();
    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
    
    Object.keys(localStorage).forEach(key => {
        if (key.startsWith('memo_')) {
            const dateStr = key.split('_')[1];
            if (dateStr && new Date(dateStr) < oneWeekAgo) {
                localStorage.removeItem(key);
            }
        }
    });
});
</script>

{% endblock %} 